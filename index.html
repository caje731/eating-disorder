<!DOCTYPE html>
<html>
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
		<title>Mass Blurb - Scanner</title>
	</head>
	<body>
		<div id="formContainer">
			<form>
				<label for="srchName">Name</label>
				<input type="text" id="srchName" name="srchName"/>
				
				<label for="srchLocation">Location</label>
				<input type="text" id="srchLocation" name="srchLocation"/>
				
				<label for="srchArea">Area</label>
				<input type="text" id="srchArea" name="srchArea"/>
				
				<label for="srchCity">City</label>
				<input type="text" id="srchCity" name="srchCity"/>
				
				<label for="srchState">State</label>
				<input type="text" id="srchState" name="srchState"/>
				
				<label for="srchPIN">PIN Code</label>
				<input type="text" id="srchPIN" name="srchPIN"/>
				
				<label for="srchCategory">Category</label>
				<input type="text" id="srchCategory" name="srchCategory"/>
				
				
				<input type="button" label="Submit" onclick="beginSearch()" value="Submit"/>
			</form>
		</div>
		<br/>
		<div id="divListingsTable">
			<table>
				<tr>
					<td>
						<table border=1>
							<th>Source</th>
<!--							<tr><td>AllProducts</td></tr>	
							<tr><td>AmericanTowns</td></tr>	
-->							<tr><td>AskLaila</td></tr>
							<tr><td>Burrp</td></tr>			
<!--							<tr><td>CityGrid</td>	</tr>	
							<tr><td>EC21</td>	</tr>
							<tr><td>ECPlaza</td></tr>		
							<tr><td>EveningFlavours</td></tr>
							<tr><td>ExportersIndia</td></tr>	
-->							<tr><td>FourSquare</td></tr>	
<!--							<tr><td>HotFrog</td></tr>		
							<tr><td>IndiaMart</td>	</tr>	
-->							<tr><td>JustDial India</td> </tr>
<!--							<tr><td>JustDial US</td>	</tr>
							<tr><td>Local</td>		</tr>	
							<tr><td>PhoneNumber</td></tr>	
							<tr><td>Pocketly</td>	</tr>	
							<tr><td>SuperPages</td>	</tr>	
							<tr><td>ThomasNet</td>	</tr>
-->							<tr><td>TimesCity</td>	</tr>	
<!--							<tr><td>YellowBot</td>	</tr>	
							<tr><td>YellowPages</td>	</tr>
							<tr><td>Yelp</td>			</tr> 
-->							<tr><td>Zomato</td>		</tr>	
							<tr><td>Zootout</td>	</tr>	
						</table>
					</td>
					<td>
						<table border=1>
							<th>Business Name</th><th>Address</th><th>Phone</th><th>Timings</th>
<!--							<tr id="allproducts">	<td colspan=4 >-</td>	</tr>
							<tr id="americantowns">	<td colspan=4 >-</td>	</tr>
-->							<tr id="asklaila">		<td colspan=4 >-</td>	</tr>	
							<tr id="burrp">			<td colspan=4 >-</td>	</tr>
<!--							<tr id="citygrid">		<td colspan=4 >-</td>	</tr>
							<tr id="ec21">			<td colspan=4 >-</td>	</tr>
							<tr id="ecplaza">		<td colspan=4 >-</td>	</tr>
							<tr id="eveningflavours"><td colspan=4>-</td>	</tr>
							<tr id="exportersindia"><td colspan=4 >-</td>	</tr>
-->							<tr id="foursquare">	<td colspan=4 >-</td>	</tr>
<!--							<tr id="hotfrog">		<td colspan=4 >-</td>	</tr>
							<tr id="indiamart">		<td colspan=4 >-</td>	</tr>
-->							<tr id="justdialindia"> <td colspan=4 >-</td>	</tr>
<!--							<tr id="justdialUS">	<td colspan=4 >-</td>	</tr>
							<tr id="local">			<td colspan=4 >-</td>	</tr>
							<tr id="phonenumber">	<td colspan=4 >-</td>	</tr>
							<tr id="pocketly">		<td colspan=4 >-</td>	</tr>
							<tr id="superpages">	<td colspan=4 >-</td>	</tr>
							<tr id="thomasnet">		<td colspan=4 >-</td>	</tr>
-->							<tr id="timescity">		<td colspan=4 >-</td>	</tr>
<!--							<tr id="yellowbot">		<td colspan=4 >-</td>	</tr>
							<tr id="yellowpages">	<td colspan=4 >-</td>	</tr>
							<tr id="yelp"> 			<td colspan=4 >-</td>	</tr>
-->							<tr id="zomato">		<td colspan=4 >-</td>	</tr>
							<tr id="zootout">		<td colspan=4 >-</td>	</tr>
						</table>
					</td>
					
		</div>
	</body>
	<script type="text/javascript">

	var SRCH_TMPL 			= "<td colspan=4> <font color='gray'>SEARCHING... </font></td>";
	var NOLIST_TMPL 		= "<td colspan=4> <font color='red'>NO LISTING </font></td>";
	var POLL_TIME_MS 		= 2000		// Interval for polling the server
	var getListings_url 		= window.location.protocol+"//"+window.location.hostname+':9000/getListings.py';
	var pendingJobs			= [] 	// list of job ids whose crawl-results need to be fetched next
	
	// Create a new instance of an XML HTTP Request
	function newXHR(){
		var xhr;
		try{
			try{
				xhr = new XMLHttpRequest()
			}catch(e){
				xhr = new ActiveXObject("Microsoft.XMLHTTP");
			}
		}catch(e){
				console.error('Something went wrong with xhr initialisation: '+ e)
				return null;
		}
		return xhr;
	}

	// Begin a new search 
	function beginSearch(){
	
		var xhr = newXHR();
		
		xhr.onreadystatechange = function (){
			if(xhr.status == 200 && xhr.readyState == 4){
				// Extract all JSON sub-strings from the response
				var myRe = /{.*?}/g;		
				while ((myArray = myRe.exec(xhr.responseText)) !== null)
				{	
					var JSONobj = JSON.parse(myArray[0]);
					if ("jobid" in JSONobj){
						pendingJobs.push(JSONobj["jobid"]);
					}
				}
				window.setTimeout(function(){getJobsData(pendingJobs)},POLL_TIME_MS);
			}
		};
		
		xhr.open('POST', getListings_url, true);
		xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
		xhr.send(encodeURI('action=TRIGGER'+
				 '&query='		+ document.getElementById("srchName").value 	+
				 '&city='		+ document.getElementById("srchCity").value 	+
				 '&location='	+ document.getElementById("srchLocation").value	+
				 '&area='		+ document.getElementById("srchArea").value 	+
				 '&state='		+ document.getElementById("srchState").value	+
				 '&pincode='	+ document.getElementById("srchPIN").value 		+
				 '&category='	+ document.getElementById("srchCategory").value));
		
//		document.getElementById("allproducts").innerHTML 	= SRCH_TMPL;
//		document.getElementById("americantowns").innerHTML 	= SRCH_TMPL;
		document.getElementById("asklaila").innerHTML 		= SRCH_TMPL;
		document.getElementById("burrp").innerHTML 		= SRCH_TMPL;
//		document.getElementById("citygrid").innerHTML 		= SRCH_TMPL;
//		document.getElementById("ec21").innerHTML 		= SRCH_TMPL;
//		document.getElementById("ecplaza").innerHTML 		= SRCH_TMPL;
//		document.getElementById("eveningflavours").innerHTML 	= SRCH_TMPL;
//		document.getElementById("exportersindia").innerHTML 	= SRCH_TMPL;
		document.getElementById("foursquare").innerHTML 	= SRCH_TMPL;
//		document.getElementById("hotfrog").innerHTML 		= SRCH_TMPL;
//		document.getElementById("indiamart").innerHTML		= SRCH_TMPL;
		document.getElementById("justdialindia").innerHTML 	= SRCH_TMPL;
//		document.getElementById("justdialus").innerHTML 	= SRCH_TMPL;
//		document.getElementById("local").innerHTML 		= SRCH_TMPL;
//		document.getElementById("phonenumber").innerHTML 	= SRCH_TMPL;
//		document.getElementById("pocketly").innerHTML 		= SRCH_TMPL;
//		document.getElementById("superpages").innerHTML 	= SRCH_TMPL;
//		document.getElementById("thomasnet").innerHTML 		= SRCH_TMPL;
		document.getElementById("timescity").innerHTML 		= SRCH_TMPL;
//		document.getElementById("yellowbot").innerHTML 		= SRCH_TMPL;
//		document.getElementById("yellowpages").innerHTML 	= SRCH_TMPL;
//		document.getElementById("yelp").innerHTML 		= SRCH_TMPL;
		document.getElementById("zomato").innerHTML 		= SRCH_TMPL;
		document.getElementById("zootout").innerHTML 		= SRCH_TMPL;
		
	}

	
	// Get the crawl-results of the specified jobs
	function getJobsData(jobIds){
	
		
		var xhr 	 		= newXHR();
		
		xhr.onreadystatechange = function(){
			if(xhr.status == 200 && xhr.readyState == 4){
				
				
				// --------- Clean the response so it is JSON parsable -----------
				var temp1 = xhr.responseText;
				var temp2;
				while(true){ 
					temp2 = temp1; 
					//remove unicode marker and replace ' by " since JSON.parse will not accept '
					temp1 = temp1.replace("u'", "'").replace("'", "\""); 
					if (temp2==temp1){
						break; // stop since there were no replacements
					}
				}
				respObj = JSON.parse(temp2);
				
				// ---------- Extract required lists -----------------
				pendingJobs 	= respObj["pending"	];
				emptyCrawls		= respObj["empty"	];
				finishedItems	= respObj["finished"];
				
				// TODO render finished items
				for ( element in finishedItems ){
					item 		= finishedItems[element];
					websource 	= item.websource;
					name 		= item.name;
					address		= item.address;
					phone		= item.phone;
					timings		= item.timings;
					
					document.getElementById(websource).setAttribute("colspan", 1);
					document.getElementById(websource).innerHTML = 	"<td>"+name+"</td>"+
																	"<td>"+address+"</td>"+
																	"<td>"+phone+"</td>"+
																	"<td>"+timings+"</td>";
					//console.log(finishedItems[element]);
				}
				
				for ( element in emptyCrawls ){
					try{
						document.getElementById(emptyCrawls[element]).innerHTML 	= NOLIST_TMPL;
					}catch(e){
						console.log(emptyCrawls[element]);
					}
				}
				
				
				// ---------- Poll the server for pending jobs --------
				if(pendingJobs.length > 0){
					// Give the server some time to finish the pending jobs, and then query again
					window.setTimeout(function(){getJobsData(pendingJobs)},POLL_TIME_MS);
				}
			}
		};
		xhr.open('POST', getListings_url, true);
		xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
		xhr.send(encodeURI(	'action=RECEIVE'+
							'&jobIds='+jobIds));
		
	}
	</script>
</html>
