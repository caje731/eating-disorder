<!DOCTYPE html>
<html>
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
		<title>Mass Blurb - Scanner</title>

		<!-- The angular library -->
		<script src="/html/js/angular.min.js"></script>
		<!-- <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.3.12/angular.min.js"></script> -->
		
		<!-- Application's top-level angular script-->
		<script src="/html/js/app.js"></script>

		<!-- Services -->
		<script src="/html/js/scannerAPI.js"></script>

		<!-- Controllers -->
		<script src="/html/js/ScannerCtrl.js"></script>
	</head>

	<body ng-app="scanner">
		<input-form></input-form>
		<br/>
		<results-table></results-table>
	</body>
	
	<script type="text/javascript">

	var SRCH_TMPL 			= "<td colspan=4> <font color='gray'>Searching...	</font></td>";
	var NOLIST_TMPL 		= "<td colspan=4> <font color='blue'>No Listing Found	</font></td>";
	var ERROR_TMPL			= "<td colspan=4> <font colot='red' >Search failed	</font></td>";
	var POLL_TIME_MS 		= 2000		// Interval for polling the server
//	var actionProcessor_url		= window.location.protocol+"//"+window.location.hostname+':9000/actionProcessor.py';
	var actionProcessor_url		= 'http://localhost:9000/actionProcessor.py';
	var pendingJobs			= [] 	// list of job ids whose crawl-results need to be fetched next
	
	// Create a new instance of an XML HTTP Request
	function newXHR(){
		var xhr;
		try{
			try{
				xhr = new XMLHttpRequest()
			}catch(e){
				xhr = new ActiveXObject("Microsoft.XMLHTTP");
			}
		}catch(e){
				console.error('Something went wrong with xhr initialisation: '+ e)
				return null;
		}
		return xhr;
	}

	// Begin a new search 
	function beginSearch(){
	
		var xhr = newXHR();
		
		pendingJobs = []  // reset for new search

		xhr.onreadystatechange = function (){
			if(xhr.status == 200 && xhr.readyState == 4){
				// Extract all JSON sub-strings from the response
				var myRe = /{.*?}/g;		
				while ((myArray = myRe.exec(xhr.responseText)) !== null)
				{	
					var JSONobj = JSON.parse(myArray[0]);
					if('execFault' in JSONobj){
						console.log(JSONobj);
						alert('An error occurred on the server. Please try again..');
						return;
					}
					if ("jobid" in JSONobj && "websource" in JSONobj){
						pendingJobs.push(JSONobj["jobid"]);
						document.getElementById(JSONobj["websource"]).setAttribute("name", JSONobj["jobid"]);
					}
				}
				window.setTimeout(function(){getJobsData(pendingJobs)},POLL_TIME_MS);
			}
		};
		
		params = encodeURI('action=TRIGGER'+
				 '&query='	+ document.getElementById("srchName").value 	+
				 '&city='	+ document.getElementById("srchCity").value 	+
				 '&location='	+ document.getElementById("srchLocation").value	+
				 '&area='	+ document.getElementById("srchArea").value );
		xhr.open('GET', actionProcessor_url+'?'+params, true);
		xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
		xhr.send();
		
		document.getElementById("asklaila").innerHTML 		= SRCH_TMPL;
		document.getElementById("burrp").innerHTML 		= SRCH_TMPL;
		document.getElementById("foursquare").innerHTML 	= SRCH_TMPL;
		document.getElementById("justdialIndia").innerHTML 	= SRCH_TMPL;
		document.getElementById("timescity").innerHTML 		= SRCH_TMPL;
		document.getElementById("zomato").innerHTML 		= SRCH_TMPL;
		document.getElementById("zootout").innerHTML 		= SRCH_TMPL;		
	}

	// Get the crawl-results of the specified jobs
	function getJobsData(jobIds){
		
		var xhr = newXHR();
		
		xhr.onreadystatechange = function(){
			if(xhr.status == 200 && xhr.readyState == 4){
				
				// --------- Clean the response so it is JSON parsable -----------
				var temp1 = xhr.responseText;
				var temp2;
				while(true){ 
					console.log('chal rai');
					temp2 = temp1; 
					//replace ' by \' since JSON.parse will not accept '
					temp1 = temp1.replace("'", "\\'");

					//remove non-breaking space \xa0 if present
					temp1 = temp1.replace("\\xa0", "")
					
					if (temp2===temp1){
						console.log('Chal gaya !');
						break; // stop since there were no replacements
					}
				}
				respObj = JSON.parse(temp2);
				
				if('execFault' in respObj){
					console.log(respObj);
					alert('An error occurred on the server. Please try again..');
					return;
				}
				
				// ---------- Extract required lists -----------------
				pendingJobs 	= respObj["pending"	];
				emptyCrawls		= respObj["empty"	];
				finishedItems	= respObj["finished"];
				erroredJobs		= respObj["error"	];
				
				console.log(pendingJobs);
				console.log(emptyCrawls);
				console.log(finishedItems);
				console.log(erroredJobs);

				for ( element in finishedItems ){
					item 		= finishedItems[element];
					websource 	= item.websource;
					name 		= item.name;
					address		= item.address;
					phone		= item.phone;
					timings		= item.timings;
					
					document.getElementById(websource).setAttribute("colspan", 1);
					document.getElementById(websource).innerHTML = 	"<td>"+name+"</td>"+
											"<td>"+address+"</td>"+
											"<td>"+phone+"</td>"+
											"<td>"+timings+"</td>";
				}
				
				for ( element in emptyCrawls ){
					try{
						document.getElementsByName(emptyCrawls[element])[0].innerHTML 	= NOLIST_TMPL;
					}catch(e){
						console.error('Could not show an empty crawl: '+emptyCrawls[element]);
					}
				}
				for(element in erroredJobs ){
					try{
						console.log(erroredJobs[element]);						
						document.getElementsByName(erroredJobs[element])[0].innerHTML		= ERROR_TMPL;
					}catch(e){
						console.error('Could not show an errored crawl: '+ erroredJobs[element]);
					}
				}
				
				
				// ---------- Poll the server for pending jobs --------
				if(pendingJobs.length > 0){
					// Give the server some time to finish the pending jobs, and then query again
					window.setTimeout(function(){getJobsData(pendingJobs)},POLL_TIME_MS);
				}
			}
		};

		params = encodeURI('action=RECEIVE&jobIds='+jobIds);
		xhr.open('GET', actionProcessor_url+'?'+params, true);
		xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
		xhr.send();
	}
	</script>
</html>
